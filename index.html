<script>
        // ... (Omitted initialization and location functions) ...
        
// --- Feature 1 & 2: Semantic Decoding & Routing (with Serverless Backend) ---

document.getElementById("semantic-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const inputText = document.getElementById("semantic-input").value;
    const button = document.getElementById('semantic-submit-button');
    const routingStatus = document.getElementById('save-routing-status'); 

    // 1. Setup UI for Loading
    button.disabled = true; 
    button.classList.add('opacity-50'); 
    button.textContent = '✨ Analyzing Situation & Status...';
    
    // Clear previous results
    document.getElementById("analysis-display").textContent = "Analyzing...";
    document.getElementById("best-match-display").textContent = "Searching for optimal PPS...";
    document.getElementById("analysis-display").classList.remove("hidden");
    document.getElementById("best-match-display").classList.remove("hidden");
    document.getElementById("jamai-citation").classList.add("hidden");

    // Clear Status Area 
    const statusContentDiv = document.getElementById('status-content');
    const statusCard = document.getElementById('local-status-results-routing');
    statusContentDiv.innerHTML = '<p class="text-sm text-gray-500 pulse-animation">Request sent to JamAI backend...</p>';
    statusCard.classList.remove('bg-green-100', 'border-green-500', 'bg-red-100', 'border-red-500', 'bg-gray-100', 'bg-yellow-100', 'border-yellow-500');
    statusCard.classList.add('bg-blue-100', 'border-blue-500'); // Loading color

    const payload = {
        user_input: inputText,
        location_details: userLocation.source !== 'Manual Input Required' ? `Lat: ${userLocation.lat.toFixed(4)}, Long: ${userLocation.lon.toFixed(4)}` : userLocation.city
    };

    // 2. Send to Serverless Backend (which handles JamAI LLM calls)
    try {
        const res = await fetch("/api/analyze", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        const data = await res.json();
        
        if (res.status === 202) {
             // FIX: Clear instructions for user to resubmit/re-fetch
             statusContentDiv.innerHTML = `<p class="text-sm whitespace-pre-wrap text-yellow-800">⚠️ **Analysis Pending.** The request (Row ID: ${data.row_id}) is running on the JamAI server. Please wait 30 seconds and click the 'Get Safe Route & Local Status' button *again* to fetch the result instantly.</p>`;
             statusCard.classList.remove('bg-blue-100', 'border-blue-500');
             statusCard.classList.add('bg-yellow-100', 'border-yellow-500');
             document.getElementById("analysis-display").textContent = "Analysis timed out on Vercel. Please resubmit the form in a moment to check for the completed result.";
             document.getElementById("best-match-display").innerHTML = `<p class="text-2xl font-extrabold text-yellow-700">Analysis Pending...</p>`;
             routingStatus.textContent = "⚠️ Polling timed out. Resubmit to fetch result.";
             
        } else if (res.ok && data.success) {
            // SUCCESS (200 OK)
            
            const tagsString = typeof data.tags === 'string' ? data.tags : '';
            const decodedTags = tagsString.split(',').map(t => t.trim()).filter(Boolean);
            window.saveFamilyData({ vulnerabilities: decodedTags.length > 0 ? decodedTags : ['N/A Pax'] });
            
            document.getElementById("current-vulnerabilities").innerHTML = `<span class="font-bold text-indigo-700">${(decodedTags.length > 0 ? decodedTags : ['N/A Pax']).join('; ')}</span>`;
            
            statusContentDiv.innerHTML = `<p class="text-sm whitespace-pre-wrap text-gray-800">✅ Routing successful. Local risk assessed based on PPS knowledge.</p>`;
            statusCard.classList.remove('bg-blue-100', 'border-blue-500');
            statusCard.classList.add('bg-green-100', 'border-green-500');

            document.getElementById("analysis-display").textContent = data.analysis || "No detailed analysis provided.";
            
            document.getElementById("best-match-display").innerHTML = `
                <p class="text-2xl font-extrabold text-green-700">Best Match Found!</p>
                <p class="text-4xl font-extrabold text-indigo-700 my-2">${data.selected_pps || 'Unknown PPS'}</p>
                <p class="text-lg text-gray-700">Proceed to the **QR Passport** tab to prepare your documents.</p>
            `;
            
            document.getElementById("jamai-citation").classList.remove("hidden");
            routingStatus.textContent = "✅ Analysis complete and route generated.";

        } else {
            // Handle API errors (400, 500, etc.)
            const errorText = data.error || data.message || (res.statusText ? `HTTP Error: ${res.statusText}` : "An unexpected network error occurred.");
            document.getElementById("analysis-display").textContent = errorText;
            document.getElementById("best-match-display").innerHTML = `<p class="text-lg font-bold text-red-600">Routing Failed</p>`;
            routingStatus.textContent = `❌ Routing failed: ${errorText}`;
            statusCard.classList.remove('bg-blue-100', 'border-blue-500');
            statusCard.classList.add('bg-red-100', 'border-red-500'); 
        }

    } catch (error) {
        console.error("Routing API Call Error:", error);
        document.getElementById("analysis-display").textContent = `Error during routing calculation: ${error.message || error}.`;
        document.getElementById("best-match-display").innerHTML = `<p class="text-lg font-bold text-red-600">Routing Failed (Network)</p>`;
        routingStatus.textContent = "❌ Network error connecting to Vercel backend.";
    } finally {
        button.disabled = false; 
        button.classList.remove('opacity-50'); 
        button.textContent = '✨ Get Safe Route & Local Status';
        showTab("routing");
    }
});
        // ... (Omitted the rest of the script) ...
    </script>
</body>
</html>