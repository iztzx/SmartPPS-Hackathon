<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHELTER CONNECT: Family-First Response</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .hero-header { background: linear-gradient(135deg, #d9534f, #c9302c); color: white; padding: 2rem 1rem; border-radius: 0 0 20px 20px; margin-bottom: 2rem; }
        .card { border: none; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .nav-pills .nav-link.active { background-color: #d9534f; }
        .nav-pills .nav-link { color: #555; }
        #qr-code { display: flex; justify-content: center; margin-top: 20px; }
        .analysis-box { background-color: #fff3f3; border-left: 5px solid #d9534f; padding: 15px; border-radius: 5px; }
        .badge-custom { background-color: #d9534f; color: white; margin-right: 5px; }
    </style>
</head>
<body>

<div class="hero-header text-center">
    <h1>SHELTER CONNECT</h1>
    <p class="lead">Intelligent Routing & Instant Registration during Floods</p>
</div>

<div class="container">
    
    <ul class="nav nav-pills mb-4 justify-content-center" id="pills-tab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="pills-route-tab" data-bs-toggle="pill" data-bs-target="#pills-route" type="button">Feature A: Find Safe Shelter</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="pills-passport-tab" data-bs-toggle="pill" data-bs-target="#pills-passport" type="button">Feature B: Digital ID (QR)</button>
        </li>
    </ul>

    <div class="tab-content" id="pills-tabContent">
        
        <div class="tab-pane fade show active" id="pills-route" role="tabpanel">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="card p-4">
                        <h4><i class="bi bi-geo-alt-fill"></i> Find the Safest PPS</h4>
                        <p class="text-muted small">We use AI to match your family's specific needs (elderly, pets, medical) to the right shelter facilities.</p>
                        
                        <form id="routingForm">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Your Location / Landmark</label>
                                <input type="text" class="form-control" id="locationInput" placeholder="e.g., Kampung Sungai Cincin, Gombak" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Family Vulnerabilities & Needs</label>
                                <textarea class="form-control" id="userInput" rows="3" placeholder="e.g., I have a bedridden grandmother (Warga Emas) and a cat. We need ground floor access." required></textarea>
                            </div>
                            <button type="submit" class="btn btn-danger w-100" id="searchBtn">Find Best Shelter</button>
                        </form>

                        <div id="loadingSpinner" class="text-center mt-4 d-none">
                            <div class="spinner-border text-danger" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Consulting JamAI Knowledge Base...</p>
                        </div>

                        <div id="resultArea" class="mt-4 d-none">
                            <hr>
                            <h5>AI Recommendation</h5>
                            <div id="tagsContainer" class="mb-2"></div>
                            <div class="analysis-box" id="analysisContent"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="pills-passport" role="tabpanel">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="card p-4">
                        <h4><i class="bi bi-qr-code"></i> Create Family Passport</h4>
                        <p class="text-muted small">Fill this once. Present the QR code at the PPS counter for instant JKM registration. Works offline.</p>
                        
                        <form id="passportForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Head of Household Name</label>
                                    <input type="text" class="form-control" id="hocName" placeholder="Full Name" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">IC Number</label>
                                    <input type="text" class="form-control" id="hocIC" placeholder="xxxxxx-xx-xxxx" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Address</label>
                                <input type="text" class="form-control" id="address" placeholder="Home Address" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Family Members Count</label>
                                <input type="number" class="form-control" id="paxCount" value="1">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Specific Needs (JKM Schema)</label>
                                <select class="form-select" id="vulnType">
                                    <option value="None">None</option>
                                    <option value="Warga Emas">Warga Emas (Elderly)</option>
                                    <option value="OKU">OKU (Disabled)</option>
                                    <option value="Ibu Mengandung">Ibu Mengandung (Pregnant)</option>
                                    <option value="Kanak-kanak">Kanak-kanak (Children)</option>
                                </select>
                            </div>
                            <button type="button" class="btn btn-primary w-100" onclick="generateQR()">Generate Offline QR</button>
                        </form>

                        <div id="qrResult" class="text-center mt-4 d-none">
                            <h5>Your Digital Passport</h5>
                            <p class="small text-success">Ready to scan at PPS Counter</p>
                            <div id="qr-code"></div>
                            <p class="text-muted small mt-2">This QR contains standard JKM admission JSON payload.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    // --- FEATURE A: API CALL TO JAMAI ---
    document.getElementById('routingForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const location = document.getElementById('locationInput').value;
        const userInput = document.getElementById('userInput').value;
        const btn = document.getElementById('searchBtn');
        const spinner = document.getElementById('loadingSpinner');
        const resultArea = document.getElementById('resultArea');
        const analysisContent = document.getElementById('analysisContent');
        const tagsContainer = document.getElementById('tagsContainer');

        // UI Reset
        btn.disabled = true;
        spinner.classList.remove('d-none');
        resultArea.classList.add('d-none');
        tagsContainer.innerHTML = '';

        try {
            // Determine API URL based on environment
            // If running on Vercel, the relative path /api/... works.
            // If running locally separate from backend, you might need full URL.
            const response = await fetch('/api/find_safe_shelter', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_input: userInput, location_details: location })
            });

            const data = await response.json();

            if (data.status === 'success') {
                // Render Tags
                if (data.tags) {
                    // Simple parsing if tags are comma separated or just string
                    const tags = data.tags.split(','); 
                    tags.forEach(tag => {
                        const span = document.createElement('span');
                        span.className = 'badge badge-custom rounded-pill';
                        span.innerText = tag.trim();
                        tagsContainer.appendChild(span);
                    });
                }

                // Render Analysis using Marked.js for Markdown support
                analysisContent.innerHTML = marked.parse(data.analysis);
                resultArea.classList.remove('d-none');
            } else {
                alert('Error: ' + (data.detail || 'Could not fetch route analysis.'));
            }

        } catch (error) {
            console.error(error);
            alert('Network error. Please try again.');
        } finally {
            spinner.classList.add('d-none');
            btn.disabled = false;
        }
    });

    // --- FEATURE B: QR GENERATION (OFFLINE) ---
    function generateQR() {
        const name = document.getElementById('hocName').value;
        const ic = document.getElementById('hocIC').value;
        const address = document.getElementById('address').value;
        const pax = document.getElementById('paxCount').value;
        const vuln = document.getElementById('vulnType').value;

        if(!name || !ic) {
            alert("Please fill in at least Name and IC");
            return;
        }

        // Construct JKM-compliant JSON payload
        const jkmPayload = {
            schema_version: "1.0",
            hoc_name: name,
            hoc_ic: ic,
            address: address,
            total_pax: parseInt(pax),
            vulnerability_category: vuln,
            timestamp: new Date().toISOString()
        };

        const qrContainer = document.getElementById("qr-code");
        qrContainer.innerHTML = ""; // Clear previous
        
        new QRCode(qrContainer, {
            text: JSON.stringify(jkmPayload),
            width: 200,
            height: 200
        });

        document.getElementById('qrResult').classList.remove('d-none');
    }

    // Trigger QR generation script load check or setup
    window.onload = function() {
        var triggerTabList = [].slice.call(document.querySelectorAll('#pills-tab button'))
        triggerTabList.forEach(function (triggerEl) {
            var tabTrigger = new bootstrap.Tab(triggerEl)
            triggerEl.addEventListener('click', function (event) {
                event.preventDefault()
                tabTrigger.show()
            })
        })
    };
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>